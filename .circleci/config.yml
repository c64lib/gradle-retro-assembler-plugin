version: 2.1
jobs:
        build:
          docker:
            - image: circleci/openjdk:11

          working_directory: ~/retro-assembler

          environment:
            JVM_OPTS: -Xms512m -Xmx1200m
            TERM: dumb

          steps:
            - checkout
            - run: ./gradlew build
            - when:
                condition:
                steps:
                  - run: ./gradlew publishPlugins -Pgradle.publish.key=${GRADLE_PUBLISH_KEY} -Pgradle.publish.secret=${GRADLE_PUBLISH_SECRET}

        publish:
          docker:
            - image: circleci/openjdk:11

          working_directory: ~/retro-assembler

          environment:
            JVM_OPTS: -Xms512m -Xmx1200m
            TERM: dumb

          steps:
            - checkout
            - run: ./gradlew build publishPlugins -Pgradle.publish.key=${GRADLE_PUBLISH_KEY} -Pgradle.publish.secret=${GRADLE_PUBLISH_SECRET} -Ptag=${CIRCLE_TAG}


workflows:
    version: 2
    build-and-deploy:
        jobs:
            - build:
                filters:
                    branches:
                        only:
                            - master
                            - develop

            - publish:
                filters:
                    branches:
                        ignore:
                            - master
                            - develop
                    tags:
                        only:
                            - /^([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+[0-9A-Za-z-]+)?$/
